{% extends 'base.html' %}

{% block content %}
       
    <div class="container">
        <select class="form-select form-select-sm mt-2" name="months" id="months" required onchange="month_selected(this)">
            <option value=1 id="January">January</option>
            <option value=2 id="February">February</option>
            <option value=3 id="March">March</option>
            <option value=4 id="April">April</option>
            <option value=5 id="May">May</option>
            <option value=6 id="June">June</option>
            <option value=7 id="July">July</option>
            <option value=8 id="August">August</option>
            <option value=9 id="September">September</option>
            <option value=10 id="October">October</option>
            <option value=11 id="November">November</option>
            <option value=12 id="December">December</option>
        </select>

        <select class="form-select form-select-sm mt-1" name="year" id="year" required onchange="year_selected(this)"></select>

        <select class="form-select form-select-sm mt-1" name="activity-type" id="activity-type" required required onchange="activity_type_selected(this)">
            <option value="Ride">Run</option>    
            <option value="Ride">Ride</option>
        </select>

        <select class="form-select form-select-sm mt-1" name="activity-type" id="activity-type">
            <option value="distance">Distance</option>    
            <option value="time">Time</option>
            <option value="pace">Pace</option>
        </select>

    </div>
    
    <div class="container">
        <div id="chartContainer" class="d-flex flex-column align-items-center p-3">  
            <h1>{{month}} {{ years[0] }}</h1>
            <canvas id="myChart"></canvas>
        </div>
    </div>
    

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script>
        // filled in from flask
        let years_on_strava = {{ years }}
        
        years_on_strava.forEach( year => {
            $("#year").append("<option value=" + year + ">" + year + "</option>")
        });

        //"global" variables for the current year and month (integers)
        let curr_month_int = $("#months option").filter(":selected").attr("value")
        let curr_month = $("#months option").filter(":selected").attr("id")
        let curr_year = $("#year option").filter(":selected").attr("value")
        let curr_type = $("#activity-type option").filter(":selected").attr("value")


        // create a bar chart showing distance for a given month
        var myChart = null
        function createChart(input_data) {
            const data = {
                datasets: [{
                    backgroundColor: 'rgb(255, 99, 132)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: input_data,
                }]
            };

            const config = {
                type: 'bar',
                data,
                options: {
                    scaleShowVerticalLines: false, 
                    plugins: {
                        legend: {
                            display: false 
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value, index, values) {
                                    return value + " km";
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: true,
                            },
                            ticks: {
                                callback: function(index) {
                                    date = new Date(this.getLabelForValue(index))

                                    if (date.getDay() == 1) {
                                        return date.toDateString()
                                    } else {
                                        return ""
                                    }
                                }
                            }
                        }
                    }
                }
            };
            
            if (myChart) {
                myChart.destroy()
            }
            
            myChart = new Chart(
                document.getElementById('myChart'),
                config
            );
        }        
        createChart({{ data|tojson }})

        function createUrl() {
            // create url using curr_* values
            return "/chart_data?" + 
                "months=" + curr_month_int +
                "&year=" + curr_year +
                "&type=" + curr_type;
        }

        // event handler for when a month is selected from the dropdown
        function month_selected(option) {
            // console.log(option.value);
            curr_month_int = option.value 

            url = createUrl()
            fetch(url)
                .then(response => response.json())
                .then(new_data => {
                    createChart(new_data)
                });
            
            curr_month = $("#months option").filter(":selected").attr("id")
            $("#chartContainer h1").replaceWith("<h1>" + curr_month + " " + curr_year + "</h1>");
        }

        // event handler for when a year is selected from the dropdown
        function year_selected(option) {
            // console.log(option.value);
            curr_year = option.value;

            url = createUrl()
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    createChart(data)
                });
            
            $("#chartContainer h1").replaceWith("<h1>" + curr_month + " " + curr_year + "</h1>");
        }

        // event handler for when activity type is selected from the dropdown
        function activity_type_selected(option) {
            console.log(option.value)
            curr_type = option.value;

            url = createUrl()
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    createChart(data)
                });
        }

    </script>

{% endblock %}